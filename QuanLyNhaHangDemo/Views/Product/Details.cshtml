@using QuanLyNhaHangDemo.Models
@model QuanLyNhaHangDemo.Models.ViewModels.ProductDetailsViewModel

@{
    ViewData["Title"] = "Detail";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-sm-3">
        <partial name="_SidebarPartial" />
    </div>

    <div class="col-sm-9 padding-right">
        <div class="product-details">
            <!--product-details-->
            <div class="col-sm-5">
                <div class="view-product">
                    <img src="~/media/products/@Model.ProductDetails.Image" alt="" width="100px" height="200px" />
                </div>          
            </div>
            <div class="col-sm-7">
                <div class="product-information">
                    <!--/product-information-->
                    <h2>@Model.ProductDetails.Name</h2>
                    <span>
                        <span>@Model.ProductDetails.Price.ToString("#,##0 VNĐ")</span>
                        <label style="margin-left:10px;">Quantity:</label>
                        <input type="number"
                               id="product-qty"
                               value="1"
                               min="1"
                               style="width:60px; text-align:center;" />

                        @if (Model.ProductDetails.Quantity > 0)
                        {
                            <button class="btn btn-default add-to-cart"
                                    data-product_id="@Model.ProductDetails.Id">
                                <i class="fa fa-shopping-cart"></i> Thêm giỏ hàng
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-default" disabled>
                                <i class="fa fa-shopping-cart"></i> Hết hàng
                            </button>
                        }
                    </span>


                    <p>
                        <b>Trạng thái:</b>
                        @if (Model.ProductDetails.Quantity > 0)
                        {
                            <span class="text-success">Còn hàng</span>
                        }
                        else
                        {
                            <span class="text-danger">Hết hàng</span>
                        }
                    </p>
                    <p><b>Danh mục:</b> @Model.ProductDetails.Category?.Name</p>
                    <p><b>Thương hiệu:</b> @Model.ProductDetails.Brand?.Name</p>
                    <p><b>Tồn kho hiện tại:</b> @Model.ProductDetails.Quantity</p>

                    <a href=""><img src="images/product-details/share.png" class="share img-responsive" alt="" /></a>
                </div><!--/product-information-->
            </div>
        </div><!--/product-details-->
        <!-- ĐỊNH MỨC NGUYÊN LIỆU -->
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4>Định mức nguyên liệu cho món này</h4>
            </div>
            <div class="panel-body">
                @if (Model.Materials != null && Model.Materials.Any())
                {
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Nguyên liệu</th>
                                <th>Số lượng / 1 món</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var m in Model.Materials)
                            {
                                <tr>
                                    <td>@m.Material?.Name</td>
                                    <td>@m.QuantityPerProduct @m.Material?.Unit</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted">Chưa khai báo định mức nguyên liệu cho món này.</p>
                }
            </div>
        </div>
        <div class="recommended_items">
            <!--recommended_items-->
            <h2 class="title text-center">Related Products</h2>

            <div id="recommended-item-carousel" class="carousel slide" data-ride="carousel">
                <div class="carousel-inner">
                    <div class="item active">
                        @foreach (var relatedProduct in ViewBag.RelatedProducts as IEnumerable<ProductModel>)
                        {
                            <div class="col-sm-4">
                                <div class="product-image-wrapper">
                                    <div class="single-products">
                                        <div class="productinfo text-center">
                                            <a asp-action="Details" asp-controller="Product" asp-route-Id="@relatedProduct.Id">
                                                <img src="~/media/products/@relatedProduct.Image" alt="@relatedProduct.Name" style="width:100%;height:200px;object-fit:cover;" />
                                                <h2>@relatedProduct.Price.ToString("#,##0 VNĐ")</h2>
                                                <p>@relatedProduct.Name</p>
                                                <p>Danh mục: @relatedProduct.Category.Name</p>
                                                <p>Thương hiệu: @relatedProduct.Brand.Name</p>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                <a class="left recommended-item-control" href="#recommended-item-carousel" data-slide="prev">
                    <i class="fa fa-angle-left"></i>
                </a>
                <a class="right recommended-item-control" href="#recommended-item-carousel" data-slide="next">
                    <i class="fa fa-angle-right"></i>
                </a>
            </div>

        </div><!--/recommended_items-->

    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            $('.add-to-cart').click(function (e) {
                e.preventDefault();

                var Id = $(this).data("product_id");
                var qty = parseInt($('#product-qty').val(), 10);

                if (isNaN(qty) || qty <= 0) {
                    qty = 1;
                }

                $.ajax({
                    type: "POST",
                    url: "@Url.Action("Add", "Cart")",
                    data: { Id: Id, quantity: qty },
                    success: function (result) {
                        if (result.success) {
                            Swal.fire(result.message);
                            $('#cart-total').text(result.totalItems);
                        } else {
                            Swal.fire("Lỗi", result.message, "error");
                        }
                    },
                    error: function () {
                        Swal.fire("Lỗi", "Không thể thêm sản phẩm", "error");
                    }
                });
            });
        });
    </script>
}

